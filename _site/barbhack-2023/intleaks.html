<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intleaks</title>
<link rel="stylesheet" href="/assets/css/styles.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="/assets/css/monokai.css">
  </head>
  <body data-bs-theme="dark">
    <header class="d-flex py-3 mb-4 border-bottom" style="align-items: center; justify-content: space-around;">
    <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
      <span class="fs-4"><span class="logo1">Hack</span><span class="logo2">vens</span></span>
    </a>
    <button id="btnSwitch" class="">ğŸ’¡/ğŸŒ™</button>
    <script defer="defer">
      document.getElementById('btnSwitch').addEventListener('click',()=>{
      if (document.body.getAttribute('data-bs-theme') == 'dark') {
          document.body.setAttribute('data-bs-theme','light')
          document.documentElement.style.setProperty("--logo-color1", "#161616")
      }
      else {
          document.body.setAttribute('data-bs-theme','dark')
          document.documentElement.style.setProperty("--logo-color1", "#fff")

      }
      })
    </script>
  </header>
    <div class="container">
     <div class="post">
    <div class="post__back">
    	<a href="/">&lt;-- home</a>
    </div>
    <div class="post__title">
    	<h1>Barbhack 2023 / Intleaks</h1>
	<i>August 26, 2023</i>
    </div>
    <div class="post__meta">
    	<p></p>
    </div>
    <div class="post__content"?>
        <h1 id="intleaks"><strong>INTLEAKS</strong></h1>

<p>Nous nous attaquons au challenge Web INTLEAKS. Il sâ€™agit dâ€™une application dont le but est de partager des documents dÃ©voilÃ©s par des lanceurs dâ€™alertes. La page dâ€™accueil indique que deux serveurs interne hÃ©bergent des fichiers dÃ©voilÃ©s. Lâ€™un dâ€™entre eux comprend les fichiers approuvÃ©s, et lâ€™autre ceux qui ne lâ€™ont pas Ã©tÃ©. Lâ€™objectif de ce challenge est dâ€™atteindre un fichier secret qui nâ€™a pas encore Ã©tÃ© approuvÃ© et dÃ©voilÃ©.</p>

<p>Dans un premier temps, nous remarquons sur la page dâ€™accueil quâ€™un bouton permet aux utilisateurs de sâ€™authentifier Ã  lâ€™API en tant quâ€™anonyme.</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901133133813.png" alt="image-20230901133133813" /></p>

<p>Ce bouton requÃªte le endpoint <code class="language-plaintext highlighter-rouge">/api/auth</code>, nous dÃ©livrant un jeton JWT :</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132724512.png" alt="image-20230901132724512" /></p>

<p>Nous analysons le contenu de celui-ci. Nous constatons quâ€™il est signÃ© Ã  lâ€™aide de lâ€™algorithme HS512, symÃ©trique, dont la clÃ© est ici Ã  priori stockÃ©e dans le fichier indiquÃ© par lâ€™entÃªte Â«Â kidÂ Â». Nous notons Ã©galement la prÃ©sence dâ€™un paramÃ¨tre <code class="language-plaintext highlighter-rouge">"acl"Â : Â "anon"</code> dans le corps de ce jeton.</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132741789.png" alt="image-20230901132741789" /></p>

<p>Il est possible dâ€™identifier certains endpoints de lâ€™API depuis le code source de la page.</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132754256.png" alt="image-20230901132754256" /></p>

<p>Le endpoint <code class="language-plaintext highlighter-rouge">/api/me</code> permet dâ€™afficher nos privilÃ¨ges en se basant sur notre JWT.</p>

<p>Toujours depuis la page dâ€™accueil, nous pouvons accÃ©der Ã  des documents. Ceux-ci correspondent aux documents ayant Ã©tÃ© Â«Â dÃ©voilÃ©s et approuvÃ©sÂ Â».</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132829256.png" alt="image-20230901132829256" /></p>

<p>Nous remarquons un paramÃ¨tre dans lâ€™URL correspondant au document Ã  lire. En manipulant ce paramÃ¨tre, un message indique que le nom de fichier doit se terminer par <em>.disclosed</em>.</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132842161.png" alt="image-20230901132842161" /></p>

<p>Nous parvenons Ã©galement Ã  dÃ©clencher dâ€™autres messages dâ€™erreurs, indiquant que cette fonctionnalitÃ© Ã©met des requÃªtes HTTP de la forme suivanteÂ :</p>

<ul>
  <li>http://files.internal{location}</li>
</ul>

<p><strong>files.internal</strong> correspond donc au serveur dont les fichiers ont Ã©tÃ© Â«Â dÃ©voilÃ©s et approuvÃ©sÂ Â».</p>

<p>Nous remarquons ensuite que les caractÃ¨res Â«Â ?Â Â» et Â«Â #Â Â» nous permettent dâ€™Ã©chapper la vÃ©rification de lâ€™extension. Le directory listing Ã©tant activÃ© sur <strong>files.internal</strong>, nous parvenons ainsi Ã  lister les fichiers prÃ©sents sur ce serveur web, et Ã  y accÃ©der en lecture. Nous parvenons notamment Ã  lire les fichiers source <em>app.py</em> et <em>jwt.py</em>, Ã©galement prÃ©sents sur ce serveur et contenant le code source des fonctionnalitÃ©s de lâ€™API.</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132905960.png" alt="image-20230901132905960" /></p>

<p>A partir de ce code source, nous pouvons comprendre comment sont gÃ©nÃ©rÃ©s les jetons JWT servant Ã  gÃ©rer lâ€™authentification. A partir du code source, nous identifions une LFI (Local File Inclusion) dans lâ€™entÃªte JKI du JWT.</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132931988.png" alt="image-20230901132931988" /></p>

<p>Cet entÃªte prend en entrÃ©e un fichier correspondant Ã  la clÃ© permettant de signer le jeton JWT. Ainsi, sÃ©lectionner en entrÃ©e un fichier dont nous connaissons le contenu revient Ã  connaitre la clÃ© permettant de signer le jeton.</p>

<p>De plus, nous remarquons quâ€™un JWT est considÃ©rÃ© comme administrateur sâ€™il contient, dans son corps, lâ€™entrÃ©e suivanteÂ :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"acl"Â : "admin"
</code></pre></div></div>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132956918.png" alt="image-20230901132956918" /></p>

<p>Nous cherchons donc Ã  modifier le contenu de notre JWT. Ayant obtenu le contenu de quelques fichiers sur le serveur, par exemple Â«Â app.pyÂ Â», nous pouvons utiliser ce fichier comme clÃ© pour gÃ©nÃ©rer une signature valide, et spÃ©cifier le chemin vers ce mÃªme fichier dans lâ€™entÃªteÂ Â«Â kidÂ Â» Ã  lâ€™aide de la LFI.</p>

<p>Nous rÃ©alisons donc un script python afin de gÃ©nÃ©rer un jeton JWT administrateur valide, prenant en compte les Ã©lÃ©ments prÃ©cÃ©demment Ã©noncÃ©s.</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901133015565.png" alt="image-20230901133015565" /></p>

<p>Nous validons ensuite que le JWT forgÃ© est bien valide en nous connectant Ã  lâ€™application.</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132132341.png" alt="image-20230901132132341" /></p>

<p>Nous sommes Ã  prÃ©sent en mesure de requÃªter le endpoint <code class="language-plaintext highlighter-rouge">/api/leaks</code>. Le serveur nous retourne le nom du fichier Â«Â cachÃ©Â Â» recherchÃ©, et dâ€™aprÃ¨s le code source, nous pouvons comprendre que celui est hÃ©bergÃ© sur le serveur Â«Â whisteblower.internalÂ Â».</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901133036443.png" alt="image-20230901133036443" /></p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901132048027.png" alt="image-20230901132048027" /></p>

<p>Nâ€™ayant pas accÃ¨s directement Ã  ce serveur, nous cherchons Ã  forcer lâ€™application Ã  le requÃªter via une attaque de type SSRF.</p>

<p>Pour ce faire, nous pouvons rÃ©utiliser le endpoint Â«Â /api/documentÂ Â» et manipuler le paramÃ¨tre <strong>location</strong> afin de forger une requÃªte vers le serveur whistleblower.internalÂ :</p>

<ul>
  <li>http://internal.fs@whisteblower.internal/<strong>{leak_file}</strong>?.disclosed</li>
</ul>

<p>Nous avons ainsi gagnÃ© accÃ¨s en lecture au fichier recherchÃ© et rÃ©solu ce challengeÂ :</p>

<p><img src="/assets/img/barbhack2023/intleaks/image-20230901133052785.png" alt="image-20230901133052785" /></p>


    </div>
</div>


    </div>
  </body>
</html>
