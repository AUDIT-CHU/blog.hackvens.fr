<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catch the bird</title>
<link rel="stylesheet" href="/assets/css/styles.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="/assets/css/monokai.css">
  </head>
  <body data-bs-theme="dark">
    <header class="d-flex py-3 mb-4 border-bottom" style="align-items: center; justify-content: space-around;">
    <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
      <span class="fs-4"><span class="logo1">Hack</span><span class="logo2">vens</span></span>
    </a>
    <button id="btnSwitch" class="">üí°/üåô</button>
    <script defer="defer">
      document.getElementById('btnSwitch').addEventListener('click',()=>{
      if (document.body.getAttribute('data-bs-theme') == 'dark') {
          document.body.setAttribute('data-bs-theme','light')
          document.documentElement.style.setProperty("--logo-color1", "#161616")
      }
      else {
          document.body.setAttribute('data-bs-theme','dark')
          document.documentElement.style.setProperty("--logo-color1", "#fff")

      }
      })
    </script>
  </header>
    <div class="container">
     <div class="post">
    <div class="post__back">
    	<a href="/">&lt;-- home</a>
    </div>
    <div class="post__title">
    	<h1>Sthack 2022 / Catch the bird</h1>
	<i>May 20, 2022</i>
    </div>
    <div class="post__meta">
    	<p></p>
    </div>
    <div class="post__content"?>
        <h1 id="sthack-2022">STHACK 2022</h1>

<h2 id="√©preuve-catch-the-bird-a-trip-from-web-to-irl">√âpreuve ‚ÄúCatch the bird, a trip from web to IRL‚Äù</h2>

<p>Le 20/05/2022</p>

<p>Cette √©preuve indiqu√©e dans la cat√©gorie web et physique a intrigu√© notre √©quipe qui s‚Äôest pench√©e dessus durant plus de 5h.</p>

<p>En pr√©misse de cette √©preuve, nous avons pour √©nonc√© un sc√©nario entre deux personnages ainsi qu‚Äôune carte postale avec un but pr√©cis, mettre la main sur une statuette d‚Äôoiseau:</p>

<p><img src="/assets/img/sthack2022/catch-the-bird/1.png" alt="img" class="img-responsive smallpict" /></p>

<h3 id="ecoute-radio">Ecoute radio</h3>

<p>Les termes ‚ÄúMarconi‚Äù et ‚ÄúGuglielmo‚Äù √©tant soulign√©s, nous d√©couvrons qu‚Äôils font r√©f√©rence √† l‚Äôun des pr√©curseurs de la radio. Le num√©ro de rue ‚Äú101.10‚Äù semble nous inviter √† √©couter sur cette fr√©quence FM. Nous devons donc nous munir d‚Äôun t√©l√©phone ainsi que d‚Äô√©couteurs filaires pour √©couter un message diffus√© en boucle.</p>

<p>L‚Äôorateur utilise l‚Äôalphabet phon√©tique pour transmettre son message.</p>

<p><img src="/assets/img/sthack2022/catch-the-bird/2.jpg" alt="image-20220602100444065" class="img-responsive smallpict" /></p>

<p>Nous obtenons alors le lien suivant:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>STHACKMDBIDWKYEBHKLNFNWMQHJ3OXNKE5INYLZRTWZENR752TN77OAD.ONION
</code></pre></div></div>

<h3 id="acc√®s-au-compte-adminsitrateur">Acc√®s au compte adminsitrateur</h3>

<p>Via le navigateur Tor, nous arrivons sur ce qui semble √™tre un march√© du darknet, nous y retrouvons la statuette d‚Äôoiseau dans la liste des articles vendus:</p>

<p><img src="/assets/img/sthack2022/catch-the-bird/3.png" alt="img" class="img-responsive smallpict" /></p>

<p>Une page nous indique que nous devons trouver le moyen d‚Äôeffectuer un achat afin d‚Äôobtenir des coordonn√©es GPS. Cependant, afin d‚Äôeffectuer une commande nous devons √™tre authentifi√©s, l‚Äôadministrateur est indiqu√© comme √©tant tr√®s pointilleux.</p>

<p>Nous d√©couvrons une interface d‚Äôauthentification au compte d‚Äôadministration. Nous cherchons donc √† usurper l‚Äôidentit√© de cet administrateur.</p>

<p><img src="/assets/img/sthack2022/catch-the-bird/4.png" alt="img" class="img-responsive smallpict" /></p>

<p>La page de login suivante divulgue un message d‚Äôerreur en base64 lorsque la tentative d‚Äôauthentification n‚Äôest pas correcte.</p>

<p>Nous obtenons l‚Äôerreur suivante une fois le message d√©chiffr√© :</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">An</span> <span class="n">exception</span> <span class="n">occured</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">31</span> <span class="n">of</span> <span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="nc">Controller</span><span class="o">/</span><span class="nc">LoginController</span><span class="mf">.</span><span class="n">php</span> <span class="o">---</span> <span class="nc">Invalid</span> <span class="n">password</span><span class="mf">.</span> <span class="o">---</span>

                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">render</span><span class="p">(</span><span class="s1">'login/index.html.twig'</span><span class="p">,</span> <span class="p">[</span>
                    <span class="s1">'controller_name'</span> <span class="o">=&gt;</span> <span class="s1">'LoginController'</span><span class="p">,</span>
                <span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'password'</span><span class="p">)</span> <span class="o">===</span> <span class="k">self</span><span class="o">::</span><span class="no">PASSWORD</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nv">$session</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Session</span><span class="p">();</span>
                <span class="nv">$session</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'is_admin'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">redirectToRoute</span><span class="p">(</span><span class="s1">'admin'</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nb">sleep</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s1">'Invalid password.'</span><span class="p">);</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">#[Route('/logout', name: 'app_admin_logout')]</span>
        <span class="k">public</span> <span class="k">function</span> <span class="n">logout</span> <span class="p">(</span><span class="kt">Request</span> <span class="nv">$request</span><span class="p">):</span> <span class="kt">Response</span>
        <span class="p">{</span>

            <span class="nv">$session</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Session</span><span class="p">();</span>
            <span class="nv">$session</span><span class="o">-&gt;</span><span class="nf">clear</span><span class="p">();</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">redirectToRoute</span><span class="p">(</span><span class="s1">'app_admin_login'</span><span class="p">);</span>
</code></pre></div></div>

<p>Ici nous avons d√©duit qu‚Äôil fallait r√©cup√©rer le contenu de la variable ‚Äòself::PASSWORD‚Äô.</p>

<p>Nous obtenons un autre morceau de code li√© √† une erreur au niveau de la page listant les articles:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>An exception occured on line 86 of /www/vendor/symfony/expression-language/Lexer.php --- Unexpected character "'" around position 0 for expression ' OR 1=1# &amp;&amp; true. ---

                } elseif (str_contains('.,?:', $expression[$cursor])) {
                    // punctuation
                    $tokens[] = new Token(Token::PUNCTUATION_TYPE, $expression[$cursor], $cursor + 1);
                    ++$cursor;
                } elseif (pregmatch('/[a-zA-Z\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*/A', $expression, $match, 0, $cursor)) {
                    // names
                    $tokens[] = new Token(Token::NAME_TYPE, $match[0], $cursor + 1);
                    $cursor += \strlen($match[0]);
                } else {
                    // unlexable
                    throw new SyntaxError(sprintf('Unexpected character "%s".', $expression[$cursor]), $cursor, $expression);
                }
            }
            $tokens[] = new Token(Token::EOF_TYPE, null, $cursor + 1);
            if (!empty($brackets)) {
                [$expect, $cur] = array_pop($brackets);
                throw new SyntaxError(sprintf('Unclosed "%s".', $expect), $cur, $expression);
            }
</code></pre></div></div>

<p>Nous remarquons la mention de ‚Äúexpression-language‚Äù dans le message de l‚Äôerreur ce qui nous pousse √† consulter la documentation suivante :</p>

<p>https://symfony.com/doc/current/components/expression_language/syntax.html#component-expression-functions</p>

<p>La partie ‚ÄúWorking with Functions‚Äù attire notre ≈ìil, car il semble possible de r√©cup√©rer le contenu d‚Äôune variable via la fonction ‚Äúconstant()‚Äù. De plus, il est possible d‚Äôinfluencer le message d‚Äôerreur en jouant sur un param√®tre POST. Une injection semble donc possible.</p>

<p>Apr√®s quelques tentatives et √† l‚Äôaide des messages d‚Äôerreurs, nous identifions le contexte li√© √† notre variable ‚Äúself::PASSWORD‚Äù.</p>

<p><img src="/assets/img/sthack2022/catch-the-bird/5.png" alt="img" class="img-responsive smallpict" /></p>

<p>Nous avons donc ‚Äú<strong>constant(‚ÄòApp\Controller\LoginController::PASSWORD‚Äô)</strong>‚Äù.</p>

<p>N√©anmoins, apr√®s avoir r√©cup√©r√© le contenu du mot de passe administrateur nous devons trouver un moyen de l‚Äôafficher ou de le r√©cup√©rer en clair.</p>

<p>Nous utilisons alors une autre fonction basique de symfony : <strong>matches</strong> afin de v√©rifier les caract√®res un √† un.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>constant('App\\Controller\\LoginController::PASSWORD') matches '/a*/'
</code></pre></div></div>

<p>Ce qui nous permet d‚Äôidentifier manuellement le mot de passe comme √©tant : <strong>Ybhr5vmjJD</strong></p>

<h3 id="r√©cup√©rer-et-d√©chiffrement-dun-fichier">R√©cup√©rer et d√©chiffrement d‚Äôun fichier</h3>

<p>Nous  acc√©dons ensuite √† la liste des ventes effectu√©es, et obtenons les √©l√©ments tant attendus, √† savoir les coordonn√©es GPS du point o√π se trouvent un cadenas et une cl√© secr√®te.</p>

<p><img src="/assets/img/sthack2022/catch-the-bird/6.png" alt="img" class="img-responsive smallpict" /></p>

<p>Le point GPS nous emm√®ne dans les jardins de la mairie de Bordeaux, o√π nous d√©couvrons un cadenas verrouill√© auquel est attach√© une cl√© USB.</p>

<p><img src="/assets/img/sthack2022/catch-the-bird/7.png" alt="img" class="img-responsive smallpict" /></p>

<p>L‚Äôusage de comp√©tence de lock-picking est utile pour r√©cup√©rer la cl√© USB, cependant dans notre cas nous manquions de temps et avons d√©plac√© directement notre pc afin de brancher la cl√© USB sans avoir besoin d‚Äôouvrir le cadenas.</p>

<p>Une fois le fichier r√©cup√©r√©, une simple commande permet de le d√©chiffrer √† l‚Äôaide de la cl√© pr√©c√©demment retrouv√©e lors de l‚Äôachat ci-dessus :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl enc -d -aes-256-cbc -in maltesefalcon.txt.aes256cbc -out file.dec
</code></pre></div></div>

<p>Nous obtenons alors un autre lien ONION:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The auction will take place at the address : maltapyzyfnwvgkl4se7tlhlrohule77cgnaguy2nouxyvosovjldbyd.onion

All bid will be made in $ only, you will be asked to provide an bank account address on auction start. You will only be able to bid up to this account available balance, so be sure to gather sufficients funds on this account before auction start.

Auction admittance will start at 2022-05-23 20:00:00 UTC and entree will remain open up to 2022-05-23 20:15:00 UTC. Past that, nobody will be accepted and auctions will start.

---------
Falcon
</code></pre></div></div>

<h3 id="r√©cup√©ration-du-flag">R√©cup√©ration du flag</h3>

<p>La vente aux ench√®res semble commencer deux jours apr√®s la fin du CTF. En effet, un compte √† rebours est pr√©sent sur la page d‚Äôaccueil du nouveau site.</p>

<p>Nous changeons donc la date de notre pc afin de r√©duire ce d√©lai √† 0. Ceci n‚Äô√©tait pas la m√©thode d√©sir√©e par le cr√©ateur du challenge, mais une m√©thode qui fonctionne tout de m√™me. C‚Äôest ainsi que nous avons obtenu le flag et valid√© l‚Äô√©preuve :</p>

<p><img src="/assets/img/sthack2022/catch-the-bird/8.png" alt="img" class="img-responsive smallpict" /></p>

<p><img src="/assets/img/sthack2022/catch-the-bird/9.png" alt="img" class="img-responsive smallpict" /></p>

    </div>
</div>


    </div>
  </body>
</html>
